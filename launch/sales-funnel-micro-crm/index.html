<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Funnel CRM | TCTC Digital Alchemy</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-container">
        <div class="glass-panel auth-panel">
            <h1>Sales Funnel CRM</h1>
            <p class="subtitle">Digital Alchemy Platform</p>
            
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <input type="email" id="login-email" placeholder="Email" class="input-field">
                <input type="password" id="login-password" placeholder="Password" class="input-field">
                <button id="login-btn" class="btn btn-primary">Login</button>
                <div style="text-align: center; margin: 1rem 0; color: var(--text-secondary);">or</div>
                <button id="email-link-login-btn" class="btn btn-secondary" style="width: 100%;">üìß Send Login Link (No Password)</button>
                <p class="auth-toggle">Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
            </div>

            <div id="signup-form" class="auth-form" style="display: none;">
                <h2>Sign Up</h2>
                <input type="text" id="signup-name" placeholder="Full Name" class="input-field">
                <input type="email" id="signup-email" placeholder="Email" class="input-field">
                <input type="password" id="signup-password" placeholder="Password" class="input-field">
                <button id="signup-btn" class="btn btn-primary">Sign Up</button>
                <div style="text-align: center; margin: 1rem 0; color: var(--text-secondary);">or</div>
                <button id="email-link-signup-btn" class="btn btn-secondary" style="width: 100%;">üìß Send Sign-Up Link (No Password)</button>
                <p class="auth-toggle">Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="container header-content">
                <div class="logo-section">
                    <h1>‚ö° Sales Funnel CRM</h1>
                </div>
                <nav class="main-nav">
                    <a href="#dashboard" class="nav-link active" data-view="dashboard">Dashboard</a>
                    <a href="#pipeline" class="nav-link" data-view="pipeline">Pipeline</a>
                    <a href="#analytics" class="nav-link" data-view="analytics">Analytics</a>
                    <a href="#settings" class="nav-link" data-view="settings">Settings</a>
                </nav>
                <div class="header-actions">
                    <button id="theme-toggle" class="icon-btn" title="Toggle Theme">üåô</button>
                    <button id="add-lead-btn" class="btn btn-primary">+ Add Lead</button>
                    <div class="user-menu">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container main-content">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view active">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card glass-panel">
                        <div class="stat-icon">üìä</div>
                        <h3>Total Leads</h3>
                        <p class="stat-value" id="stat-total-leads">0</p>
                        <p class="stat-label">All time</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-icon">üìÖ</div>
                        <h3>This Month</h3>
                        <p class="stat-value" id="stat-month-leads">0</p>
                        <p class="stat-label">New leads</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-icon">üí∞</div>
                        <h3>Pipeline Value</h3>
                        <p class="stat-value" id="stat-pipeline-value">$0</p>
                        <p class="stat-label">Estimated</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <div class="stat-icon">üìà</div>
                        <h3>Conversion Rate</h3>
                        <p class="stat-value" id="stat-conversion-rate">0%</p>
                        <p class="stat-label">This quarter</p>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="glass-panel ai-insights-panel">
                    <div class="panel-header">
                        <h2>‚ú® Gemini AI Insights</h2>
                        <button id="refresh-insights" class="btn btn-secondary">Refresh</button>
                    </div>
                    <div id="ai-insights" class="ai-insights-content">
                        <div class="loading">Analyzing your pipeline...</div>
                    </div>
                </div>

                <!-- Leads Section -->
                <div class="leads-section">
                    <div class="section-header">
                        <h2>Recent Leads</h2>
                        <div class="section-actions">
                            <div class="search-box">
                                <input type="text" id="search-leads" placeholder="Search leads..." class="input-field">
                            </div>
                            <div class="filter-group">
                                <select id="filter-stage" class="input-field">
                                    <option value="">All Stages</option>
                                    <option value="New Lead">New Lead</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal Sent">Proposal Sent</option>
                                    <option value="Closed">Closed</option>
                                </select>
                                <select id="filter-score" class="input-field">
                                    <option value="">All Scores</option>
                                    <option value="high">High (70+)</option>
                                    <option value="medium">Medium (40-69)</option>
                                    <option value="low">Low (0-39)</option>
                                </select>
                            </div>
                            <div class="view-toggle">
                                <button id="view-grid" class="icon-btn active" title="Grid View">‚äû</button>
                                <button id="view-list" class="icon-btn" title="List View">‚ò∞</button>
                            </div>
                        </div>
                    </div>
                    <div id="leads-container" class="leads-grid">
                        <!-- Lead cards populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Pipeline View -->
            <div id="view-pipeline" class="view">
                <div class="pipeline-header">
                    <h2>Sales Pipeline</h2>
                    <div class="pipeline-stats">
                        <span>Total Value: <strong id="pipeline-total-value">$0</strong></span>
                    </div>
                </div>
                <div class="kanban-board">
                    <div class="kanban-column" data-stage="New Lead">
                        <div class="column-header">
                            <h3>New Lead</h3>
                            <span class="column-count">0</span>
                        </div>
                        <div class="column-content" data-stage="New Lead">
                            <!-- Cards dropped here -->
                        </div>
                    </div>
                    <div class="kanban-column" data-stage="Contacted">
                        <div class="column-header">
                            <h3>Contacted</h3>
                            <span class="column-count">0</span>
                        </div>
                        <div class="column-content" data-stage="Contacted"></div>
                    </div>
                    <div class="kanban-column" data-stage="Qualified">
                        <div class="column-header">
                            <h3>Qualified</h3>
                            <span class="column-count">0</span>
                        </div>
                        <div class="column-content" data-stage="Qualified"></div>
                    </div>
                    <div class="kanban-column" data-stage="Proposal Sent">
                        <div class="column-header">
                            <h3>Proposal Sent</h3>
                            <span class="column-count">0</span>
                        </div>
                        <div class="column-content" data-stage="Proposal Sent"></div>
                    </div>
                    <div class="kanban-column" data-stage="Closed">
                        <div class="column-header">
                            <h3>Closed</h3>
                            <span class="column-count">0</span>
                        </div>
                        <div class="column-content" data-stage="Closed"></div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="view-analytics" class="view">
                <h2>Analytics & Insights</h2>
                
                <div class="analytics-grid">
                    <div class="glass-panel chart-panel">
                        <h3>Conversion Funnel</h3>
                        <div id="conversion-funnel" class="chart-container"></div>
                    </div>
                    
                    <div class="glass-panel chart-panel">
                        <h3>Lead Sources</h3>
                        <div id="lead-sources-chart" class="chart-container"></div>
                    </div>
                    
                    <div class="glass-panel chart-panel">
                        <h3>Sales Velocity</h3>
                        <div id="sales-velocity" class="chart-container"></div>
                    </div>
                    
                    <div class="glass-panel chart-panel">
                        <h3>Revenue Forecast</h3>
                        <div id="revenue-forecast" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="view">
                <h2>Settings</h2>
                
                <div class="settings-grid">
                    <div class="glass-panel">
                        <h3>Email Templates</h3>
                        <button id="add-template-btn" class="btn btn-primary">+ New Template</button>
                        <div id="templates-list" class="templates-list"></div>
                    </div>
                    
                    <div class="glass-panel">
                        <h3>Export Leads</h3>
                        <button id="export-csv-btn" class="btn btn-secondary">üì§ Export CSV</button>
                        <p class="help-text">Download all leads with AI scores, stages, activity counts, and complete details</p>
                    </div>
                    
                    <div class="glass-panel">
                        <h3>ü§ñ Gemini AI Configuration</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Configure your personal Google Gemini API key to enable AI features like lead scoring, email drafting, and insights generation.
                        </p>
                        
                        <div id="api-key-status" style="margin-bottom: 1rem;">
                            <!-- Status will be inserted here -->
                        </div>
                        
                        <div class="form-group">
                            <label for="gemini-api-key" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                Google Gemini API Key *
                            </label>
                            <input 
                                type="password" 
                                id="gemini-api-key" 
                                class="input-field" 
                                placeholder="Enter your Gemini API key"
                                style="width: 100%; margin-bottom: 0.5rem;"
                            >
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button id="save-api-key" class="btn btn-primary" style="flex: 1;">üíæ Save API Key</button>
                                <button id="test-api-key" class="btn btn-secondary" style="flex: 1;">üß™ Test Connection</button>
                            </div>
                        </div>
                        
                        <div class="help-text" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p style="margin: 0 0 0.5rem 0; font-weight: 600;">üìö How to get your API key:</p>
                            <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent);">Google AI Studio</a></li>
                                <li>Sign in with your Google account</li>
                                <li>Click "Create API Key" or "Get API Key"</li>
                                <li>Copy the key and paste it above</li>
                            </ol>
                            <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--text-tertiary);">
                                üí° <strong>Free tier includes:</strong> 60 requests/minute, 1,500 requests/day<br>
                                üîí <strong>Privacy:</strong> Your API key is stored locally in your browser only
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="lead-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2 id="modal-title">Add New Lead</h2>
                <button class="modal-close">&times;</button>
            </div>
            <form id="lead-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="lead-name" required class="input-field">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="lead-email" required class="input-field">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="lead-phone" class="input-field">
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" id="lead-company" class="input-field">
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <select id="lead-source" class="input-field">
                            <option value="Website">Website</option>
                            <option value="Referral">Referral</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Cold Call">Cold Call</option>
                            <option value="Event">Event</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stage</label>
                        <select id="lead-stage" class="input-field">
                            <option value="New Lead">New Lead</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Proposal Sent">Proposal Sent</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Value ($)</label>
                        <input type="number" id="lead-value" class="input-field">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="lead-tags" placeholder="hot, enterprise, demo-scheduled" class="input-field">
                    </div>
                    <div class="form-group full-width">
                        <label>Notes</label>
                        <textarea id="lead-notes" rows="4" class="input-field"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content glass-panel large-modal">
            <div class="modal-header">
                <h2 id="detail-lead-name"></h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="detail-content">
                <div class="detail-sidebar">
                    <div class="detail-section">
                        <h3>Contact Info</h3>
                        <p><strong>Email:</strong> <span id="detail-email"></span></p>
                        <p><strong>Phone:</strong> <span id="detail-phone"></span></p>
                        <p><strong>Company:</strong> <span id="detail-company"></span></p>
                        <p><strong>Source:</strong> <span id="detail-source"></span></p>
                    </div>
                    <div class="detail-section">
                        <h3>Lead Info</h3>
                        <p><strong>Stage:</strong> <span id="detail-stage"></span></p>
                        <p><strong>Score:</strong> <span id="detail-score" class="score-badge"></span></p>
                        <p><strong>Value:</strong> <span id="detail-value"></span></p>
                        <p><strong>Created:</strong> <span id="detail-created"></span></p>
                        <p><strong>Last Contact:</strong> <span id="detail-last-contact"></span></p>
                    </div>
                    <div class="detail-section">
                        <h3>Tags</h3>
                        <div id="detail-tags" class="tags-container"></div>
                    </div>
                    <div class="detail-section">
                        <h3>AI Actions</h3>
                        <button id="ai-score-btn" class="btn btn-secondary">ü§ñ Re-score Lead</button>
                        <button id="ai-email-btn" class="btn btn-secondary">‚úâÔ∏è Draft Email</button>
                        <button id="ai-action-btn" class="btn btn-secondary">üí° Next Action</button>
                    </div>
                    <div class="detail-section">
                        <h3>Actions</h3>
                        <button id="edit-lead-btn" class="btn btn-primary">Edit Lead</button>
                        <button id="delete-lead-btn" class="btn btn-danger">Delete Lead</button>
                    </div>
                </div>
                <div class="detail-main">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="timeline">Timeline</button>
                        <button class="tab-btn" data-tab="notes">Notes</button>
                        <button class="tab-btn" data-tab="ai-insights">AI Insights</button>
                    </div>
                    
                    <div id="tab-timeline" class="tab-content active">
                        <div class="activity-header">
                            <h3>Activity Timeline</h3>
                            <button id="add-activity-btn" class="btn btn-secondary">+ Add Activity</button>
                        </div>
                        <div id="activity-timeline" class="timeline"></div>
                    </div>
                    
                    <div id="tab-notes" class="tab-content">
                        <textarea id="lead-notes-field" class="input-field" rows="10"></textarea>
                        <button id="save-notes-btn" class="btn btn-primary">Save Notes</button>
                    </div>
                    
                    <div id="tab-ai-insights" class="tab-content">
                        <div id="lead-ai-insights" class="ai-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activity-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>Add Activity</h2>
                <button class="modal-close">&times;</button>
            </div>
            <form id="activity-form">
                <div class="form-group">
                    <label>Type *</label>
                    <select id="activity-type" required class="input-field">
                        <option value="email">Email</option>
                        <option value="call">Phone Call</option>
                        <option value="meeting">Meeting</option>
                        <option value="note">Note</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="activity-description" required rows="4" class="input-field"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Activity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Email Template Modal -->
    <div id="template-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>Create Email Template</h2>
                <button class="modal-close">&times;</button>
            </div>
            <form id="template-form">
                <div class="form-group">
                    <label>Template Name *</label>
                    <input type="text" id="template-name" required class="input-field">
                </div>
                <div class="form-group">
                    <label>Subject *</label>
                    <input type="text" id="template-subject" required class="input-field">
                </div>
                <div class="form-group">
                    <label>Body *</label>
                    <textarea id="template-body" required rows="8" class="input-field"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Email Modal -->
    <div id="ai-email-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>‚ú® AI Generated Email</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="ai-email-content" class="ai-email-preview">
                <div class="loading">Generating email...</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary modal-close">Close</button>
                <button id="copy-email-btn" class="btn btn-primary">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- API Key Setup Modal -->
    <div id="api-key-setup-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>ü§ñ Configure Gemini AI</h2>
            </div>
            <div style="padding: 1.5rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    To enable AI-powered features like lead scoring, email drafting, and insights generation, 
                    you need to configure your Google Gemini API key.
                </p>
                
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; color: var(--accent);">üìö How to get your free API key:</h3>
                    <ol style="padding-left: 1.5rem; line-height: 1.8;">
                        <li>Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--accent); font-weight: 600;">Google AI Studio</a></li>
                        <li>Sign in with your Google account</li>
                        <li>Click "Create API Key" button</li>
                        <li>Copy the generated API key</li>
                        <li>Paste it below and click "Save & Continue"</li>
                    </ol>
                    <p style="margin-bottom: 0; font-size: 0.9rem; color: var(--text-tertiary);">
                        üí° <strong>Free tier includes:</strong> 60 requests/minute, 1,500 requests/day
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="setup-api-key" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Enter Your Gemini API Key:
                    </label>
                    <input 
                        type="password" 
                        id="setup-api-key" 
                        class="input-field" 
                        placeholder="AIza..."
                        style="width: 100%; margin-bottom: 1rem;"
                    >
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                        üîí <strong>Your key is secure:</strong> It's stored only in your browser and never shared with our servers.
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="skip-setup-btn" class="btn btn-secondary">Skip for Now</button>
                <button type="button" id="save-setup-key-btn" class="btn btn-primary">üíæ Save & Continue</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/config.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/gemini.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/leads.js"></script>
    <script src="js/pipeline.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
